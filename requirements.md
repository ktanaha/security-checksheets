# セキュリティチェックシート抽出・ナレッジ化Webアプリ 要件定義（たたき台 v0.2）

## 1. 背景・目的

### 1.1 背景
- SaaS事業者として、顧客からセキュリティチェックシート（主にExcel）の回答依頼を受ける業務がある。
- 顧客ごとにフォーマット／質問／回答形式／質問数がバラバラで、標準化されていない。
- 現状、質問・回答の抽出は手動コピペが中心で、工数・ミス・属人化が課題である。

### 1.2 目的
- バラバラなExcelチェックシートから、質問・回答・担当部門を効率よく抽出し、ナレッジとして永続的に蓄積できる状態を作る。
- 一部手作業を許容しつつ、抽出・整形・再利用（検索/転用）のボトルネックを大幅に削減する。

### 1.3 想定ユーザー
- セキュリティチェックシート回答の主担当（例：CS、情報システム/セキュリティ、法務、開発、営業支援など）
- レビュー/承認担当（将来拡張でワークフロー導入の可能性）
- 複数人（部門横断）で同じ案件を分担して利用することを前提とする。

---

## 2. スコープ

### 2.1 MVPで実現すること
- Excelファイル（.xlsx/.xls）を取り込み、シート選択・プレビューのうえ抽出を支援する。
- 質問・回答・担当部門の抽出結果を **永続保存（ナレッジDB化）** する。
- 生成したデータはCSVとしても出力でき、外部（他DB/ナレッジ基盤）で利用可能にする。
- 例外ケースが頻出するため、以下を前提に「手動補正しやすいUI・データモデル」を提供する。
  - 1つの質問に対して回答が複数行（複数回答）
  - 1つのセル内に複数質問が混在
  - セル結合、複数行/複数列への分割

### 2.2 MVPで実現しないこと（暫定）
- 完全自動の高精度抽出（人手ゼロでの抽出完結）
- 顧客提出用の最終成果物（Word/PDF）生成の自動化
- 高度な承認ワークフロー（段階承認、差し戻し、SLA連動など）
  - ただし「レビュー状態」など最小限の状態管理は検討対象。

---

## 3. 入力・出力

### 3.1 入力（取込対象）
- Excel: `.xlsx` を主対象
- 旧形式: `.xls` も取り込み対象
- Google Sheets由来: Excel形式に落とされたファイルも想定
- CSV入力は対象外

### 3.2 データ出力
- ナレッジDBに保存（Webアプリ上で検索・再利用）
- 必要に応じてCSVエクスポート（後段のナレッジ化/連携用）

### 3.3 CSV（エクスポート）スキーマ案
必須:
- `question`：質問テキスト（正規化済み）
- `answer`：回答テキスト（正規化済み）
- `department`：担当部門
- `source_file_name`：元ファイル名
- `sheet_name`：シート名
- `source_range`：抽出元セル範囲（例: A12:D18）

推奨（ナレッジ運用のため）:
- `customer_name`：顧客名（案件に紐づく）
- `question_group`：カテゴリ（任意：ISMS、アクセス制御等）
- `status`：状態（例: draft/reviewed/approved）※MVPではdraftのみでも可
- `created_by` / `created_at` / `updated_at`
- `version`：回答の版（将来の更新に備える）

---

## 4. ユースケース

### 4.1 主要ユースケース（MVP）
1. 顧客から受領したチェックシートをアップロードし、対象シートを選択してプレビューする。
2. 質問・回答が含まれる領域を指定し、不要領域を除外して抽出候補を生成する。
3. 例外（1セル複数質問、1質問複数回答など）をUIで分割・統合し、正しいQ/A単位に整形する。
4. 各Q/Aに担当部門を付与する（固定リスト＋追加可能）。
5. 抽出結果をナレッジとして保存し、他案件で検索・再利用できる。
6. 必要に応じてCSVとしてエクスポートする。

---

## 5. 機能要件（MVP）

### 5.1 案件（顧客・チェックシート）管理
- 案件を作成できる（顧客名、受付日、担当者などのメタデータ）
- 案件にExcelファイルを紐づけて管理できる（複数回アップロードを想定）

### 5.2 Excel取り込み・プレビュー
- .xlsx/.xlsをアップロードできる
- シート一覧から対象シートを選べる
- 表としてプレビュー表示できる（セル結合含む）
- 大きいシートでも最低限の操作性を確保する（後述の性能要件）

### 5.3 抽出支援（手動補正を前提）
- 必要領域の指定（質問・回答が含まれる範囲）
- 不要領域の除外（表頭、注釈、署名欄など）
- 質問列/回答列（または領域）の指定
- 抽出結果プレビュー（行単位のQ/A候補）

### 5.4 例外処理（頻出前提の編集機能）
- **1質問=複数回答** に対応
  - 1つの質問に複数の回答レコードを紐づけられる、または回答を複数段落として保持できる
- **1セル=複数質問** に対応
  - 1セルのテキストを分割し、複数の質問レコードとして登録できる
- 分割/統合（merge/split）
  - 質問の統合、回答の統合、Q/Aペアの再割当てができる

### 5.5 テキスト正規化（集約ルール）
- 複数セルに跨るテキストを、順序を保って連結し1つのテキストに集約する
- セル結合を考慮して「見た目の表構造」に沿ってテキストを取得する
- 連結時の整形ルール（暫定）
  - セル内改行は維持
  - セル間連結は原則改行（もしくはスペース）※要確定
  - 連続空白は1つに畳む（任意）

### 5.6 部門マスタ管理
- 部門は固定リストを基本とする
- 管理者が部門リストを追加できる（名称、表示順、無効化）
- 付与は行単位で可能
- 一括付与（選択した複数行に同一部門付与）ができる

### 5.7 ナレッジ保存・検索・再利用（MVP最小）
- 抽出したQ/AをDBに永続保存できる
- 検索できる（最低限）
  - キーワード検索（question/answer対象）
  - 部門フィルタ
  - 顧客（案件）フィルタ
- 再利用
  - 検索結果を「回答候補」としてコピー/参照できる（案件への転用は将来拡張でも可）
  - 少なくとも閲覧・コピーしやすいUIを提供する

### 5.8 エクスポート
- 案件単位、または検索結果単位でCSVエクスポートできる
- 文字化け対策としてUTF-8 with BOM等を検討する

---

## 6. 画面要件（MVP：案）

1) **案件一覧／作成**
- 案件作成（顧客名、担当など）
- 案件一覧（検索・フィルタ）

2) **案件詳細（ファイル管理）**
- Excelアップロード
- アップロード履歴（版管理の足がかり）

3) **プレビュー＆抽出設定**
- シート選択
- 範囲指定（必要/不要）
- 質問/回答の列・領域指定
- 抽出候補生成

4) **抽出結果の編集**
- Q/Aの分割・統合（例外処理）
- 部門付与（一括/個別）
- テキスト微修正

5) **ナレッジ閲覧・検索**
- キーワード検索
- フィルタ（部門、顧客/案件）
- 詳細閲覧（コピーしやすい表示）

6) **エクスポート**
- CSVダウンロード

---

## 7. 権限・ユーザー管理（MVP：方針）

- 複数人利用前提のためログイン必須とする（方式は要確定）
- 役割案
  - 管理者：admin（部門マスタ編集、ユーザー管理）
  - 一般：member（案件作成、抽出、編集、検索、エクスポート）
  - 閲覧：viewer（検索・閲覧のみ）※必要なら
- 案件のアクセス制御
  - MVPでは「全員が全案件閲覧可」でも成立するが、機微情報を踏まえ要検討

---

## 8. データ要件（概念モデル案）

- **Project（案件）**
  - customer_name, owner, created_at...
- **File（アップロードファイル）**
  - project_id, file_name, uploaded_at, uploader...
- **Sheet（シート情報）**
  - file_id, sheet_name
- **Extraction（抽出セッション）**
  - sheet_id, selected_range, excluded_ranges, settings, created_by...
- **KnowledgeItem（ナレッジQ/A）**
  - project_id（起点案件）, question, answer, department_id, source_range, status, version, timestamps

補足:
- 例外対応のため、KnowledgeItemに「分割元/統合元」の参照や、回答複数保持の設計余地を残す。

---

## 9. 非機能要件（重要度高）

### 9.1 セキュリティ（必須で詰める）
- 永続保存するため、保存データの暗号化、アクセス制御、監査ログを前提に要件化する。
- 顧客名やチェックシート内容は機微性が高い可能性がある。
- 監査ログ（最低限）
  - 誰がいつ、どの案件に対して、アップロード/編集/エクスポートしたか

### 9.2 性能（要目標設定）
- 典型的なチェックシート（行数・列数・シート数・ファイルサイズ）で実用的な処理時間であること。
- プレビュー表示と編集がストレスなく行えること。

### 9.3 可用性・バックアップ
- ナレッジDBは永続資産のためバックアップ必須（頻度・保持期間は要件化）

---

## 10. 未決事項（次に確定する論点）
- ログイン方式（社内IdP/SSOか、メール認証か）
- 案件のアクセス制御（全員閲覧可か、案件参加者のみか）
- 正規化ルール（セル間連結の区切り、箇条書きの扱い、見出しの保持）
- 例外の具体パターン整理（頻出テンプレ）とUI落とし込み
- 「再利用」の定義（閲覧・コピー止まりか、案件への差し込み/テンプレ化までやるか）
- 運用上の保持ポリシー（削除/アーカイブ、版管理）

---

## 11. MVP機能一覧（優先度）
P0（MVP必須）:
- 案件作成、Excelアップロード（.xlsx/.xls）、シート選択
- プレビュー、範囲指定（必要/不要）、質問/回答領域指定
- 抽出候補生成、編集（分割/統合）、部門付与
- ナレッジ保存、検索（キーワード＋部門＋顧客）
- CSVエクスポート

P1（早期に欲しい）:
- 監査ログ（編集/エクスポート含む）
- 版管理（ファイル/抽出結果の履歴）
- 状態管理（draft/reviewed程度）

P2（将来）:
- 高度な再利用（類似検索、回答推薦、テンプレ化）
- 承認ワークフロー
- 自動抽出精度向上（モデル/ルール）
